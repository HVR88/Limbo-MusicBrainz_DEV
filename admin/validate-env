#!/usr/bin/env bash

set -e -u

# shellcheck source=admin/lib/common.inc.bash
source "$(dirname "${BASH_SOURCE[0]}")/lib/common.inc.bash"

ENV_FILE="$MB_DOCKER_ROOT/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo >&2 "Missing .env. Run: admin/first-run"
  exit 1
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

ok=1

is_true() {
  case "${1:-}" in
    1|true|TRUE|yes|YES|on|ON) return 0 ;;
    *) return 1 ;;
  esac
}

if is_true "${MUSICBRAINZ_REPLICATION_ENABLED:-0}"; then
  if [ -z "${MUSICBRAINZ_REPLICATION_TOKEN:-}" ]; then
    echo >&2 "Replication enabled but MUSICBRAINZ_REPLICATION_TOKEN is empty."
    ok=0
  elif [ ${#MUSICBRAINZ_REPLICATION_TOKEN} -ne 40 ]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TOKEN must be 40 characters (got ${#MUSICBRAINZ_REPLICATION_TOKEN})."
    ok=0
  fi

  time_val="${MUSICBRAINZ_REPLICATION_TIME:-03:00}"
  if [[ ! "$time_val" =~ ^([01][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TIME must be HH:MM 24hr (got '$time_val')."
    ok=0
  fi
fi


# Indexing schedule validation
if is_true "${MUSICBRAINZ_INDEXING_ENABLED:-0}"; then
  time_val="${MUSICBRAINZ_INDEXING_TIME:-01:00}"
  if [[ ! "$time_val" =~ ^([01][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
    echo >&2 "MUSICBRAINZ_INDEXING_TIME must be HH:MM 24hr (got '$time_val')."
    ok=0
  fi

  freq_val="${MUSICBRAINZ_INDEXING_FREQUENCY:-weekly}"
  freq_val="${freq_val,,}"
  case "$freq_val" in
    daily|weekly|biweekly) ;;
    *)
      echo >&2 "MUSICBRAINZ_INDEXING_FREQUENCY must be daily, weekly, or biweekly (got '$freq_val')."
      ok=0
      ;;
  esac

  if [ "$freq_val" != "daily" ]; then
    day_val="${MUSICBRAINZ_INDEXING_DAY:-Sunday}"
    day_val_lc="${day_val,,}"
    case "$day_val_lc" in
      sun|sunday|mon|monday|tue|tues|tuesday|wed|wednesday|thu|thur|thurs|thursday|fri|friday|sat|saturday) ;;
      *)
        echo >&2 "MUSICBRAINZ_INDEXING_DAY must be a valid English day name (got '$day_val')."
        ok=0
        ;;
    esac
  fi
fi
if [ "$ok" -ne 1 ]; then
  exit 1
fi

echo "OK: .env looks valid."
