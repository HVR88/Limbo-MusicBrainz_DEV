name: Publish Images

on:
  push:
    branches:
      - master
    paths:
      - build/**
      - compose/**
      - docker-compose.yml
      - .env
      - .env.example
      - .github/workflows/publish-images.yml
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish-ghcr:
    name: Publish to GHCR
    runs-on: ubuntu-latest
    env:
      IMAGE_NAMESPACE: ghcr.io/${{ github.repository }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: db
            context: build/postgres-prebuilt
            dockerfile: build/postgres-prebuilt/Dockerfile
          - name: musicbrainz
            context: build/musicbrainz-prebuilt
            dockerfile: build/musicbrainz-prebuilt/Dockerfile
          - name: bootstrap
            context: build/bootstrap
            dockerfile: build/bootstrap/Dockerfile
          - name: search
            context: build/solr
            dockerfile: build/solr/Dockerfile
          - name: indexer
            context: build/sir
            dockerfile: build/sir/Dockerfile
          - name: mq
            context: build/rabbitmq
            dockerfile: build/rabbitmq/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Load build vars
      # shellcheck disable=SC1091
        run: |
          set -e
          REPO_LC=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAMESPACE=ghcr.io/${REPO_LC}" >> "$GITHUB_ENV"

          source .env

          echo "POSTGRES_VERSION=$POSTGRES_VERSION" >> "$GITHUB_ENV"
          echo "MB_SOLR_VERSION=$MB_SOLR_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_SERVER_VERSION=$MUSICBRAINZ_SERVER_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_BUILD_SEQUENCE=$MUSICBRAINZ_BUILD_SEQUENCE" >> "$GITHUB_ENV"

          DB_BUILD_SEQUENCE=$(sed -n 's/^ARG DB_BUILD_SEQUENCE=//p' build/postgres-prebuilt/Dockerfile)
          echo "DB_BUILD_SEQUENCE=${DB_BUILD_SEQUENCE:-0}" >> "$GITHUB_ENV"

          SIR_VERSION=$(sed -n 's/^ARG SIR_VERSION=//p' build/sir/Dockerfile)
          PYTHON_VERSION=$(sed -n 's/^ARG PYTHON_VERSION=//p' build/sir/Dockerfile)
          BASE_IMAGE_DATE=$(sed -n 's/^ARG BASE_IMAGE_DATE=//p' build/sir/Dockerfile)
          echo "SIR_VERSION=$SIR_VERSION" >> "$GITHUB_ENV"
          echo "PYTHON_VERSION=$PYTHON_VERSION" >> "$GITHUB_ENV"
          echo "BASE_IMAGE_DATE=$BASE_IMAGE_DATE" >> "$GITHUB_ENV"

          RABBITMQ_VERSION=$(sed -n 's/^ARG RABBITMQ_VERSION=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_VARIANT=$(sed -n 's/^ARG RABBITMQ_VARIANT=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_TAG="${RABBITMQ_VERSION}${RABBITMQ_VARIANT}"
          echo "RABBITMQ_VERSION=$RABBITMQ_VERSION" >> "$GITHUB_ENV"
          echo "RABBITMQ_VARIANT=$RABBITMQ_VARIANT" >> "$GITHUB_ENV"
          echo "RABBITMQ_TAG=$RABBITMQ_TAG" >> "$GITHUB_ENV"

          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags and build args
        run: |
          set -e
          BUILD_ARGS=""
          case "${{ matrix.name }}" in
            db)
              VERSION="$POSTGRES_VERSION"
              BUILD_ARGS=$'POSTGRES_VERSION='"$POSTGRES_VERSION"$'\nDB_BUILD_SEQUENCE='"$DB_BUILD_SEQUENCE"
              ;;
            musicbrainz)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            bootstrap)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            search)
              VERSION="$MB_SOLR_VERSION"
              BUILD_ARGS=$'MB_SOLR_VERSION='"$MB_SOLR_VERSION"
              ;;
            indexer)
              VERSION="$SIR_VERSION"
              BUILD_ARGS=$'SIR_VERSION='"$SIR_VERSION"$'\nPYTHON_VERSION='"$PYTHON_VERSION"$'\nBASE_IMAGE_DATE='"$BASE_IMAGE_DATE"
              ;;
            mq)
              VERSION="$RABBITMQ_TAG"
              BUILD_ARGS=$'RABBITMQ_VERSION='"$RABBITMQ_VERSION"$'\nRABBITMQ_VARIANT='"$RABBITMQ_VARIANT"$'\nRABBITMQ_TAG='"$RABBITMQ_TAG"
              ;;
            *)
              echo "Unknown image: ${{ matrix.name }}" >&2
              exit 1
              ;;
          esac

          TAGS="$IMAGE_NAMESPACE/${{ matrix.name }}:$VERSION"
          TAGS="$TAGS"$'\n'"$IMAGE_NAMESPACE/${{ matrix.name }}:sha-$SHORT_SHA"

          printf "TAGS<<'EOF'\n%s\nEOF\n" "$TAGS" >> "$GITHUB_ENV"
          printf "BUILD_ARGS<<'EOF'\n%s\nEOF\n" "$BUILD_ARGS" >> "$GITHUB_ENV"

      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ env.TAGS }}
          build-args: ${{ env.BUILD_ARGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-dockerhub:
    name: Publish to Docker Hub
    if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE_NAMESPACE: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/musicbrainz-docker
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: db
            context: build/postgres-prebuilt
            dockerfile: build/postgres-prebuilt/Dockerfile
          - name: musicbrainz
            context: build/musicbrainz-prebuilt
            dockerfile: build/musicbrainz-prebuilt/Dockerfile
          - name: bootstrap
            context: build/bootstrap
            dockerfile: build/bootstrap/Dockerfile
          - name: search
            context: build/solr
            dockerfile: build/solr/Dockerfile
          - name: indexer
            context: build/sir
            dockerfile: build/sir/Dockerfile
          - name: mq
            context: build/rabbitmq
            dockerfile: build/rabbitmq/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Load build vars
      # shellcheck disable=SC1091
        run: |
          set -e
          USER_LC=$(echo "$DOCKERHUB_USERNAME" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAMESPACE=docker.io/${USER_LC}/musicbrainz-docker" >> "$GITHUB_ENV"

          source .env

          echo "POSTGRES_VERSION=$POSTGRES_VERSION" >> "$GITHUB_ENV"
          echo "MB_SOLR_VERSION=$MB_SOLR_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_SERVER_VERSION=$MUSICBRAINZ_SERVER_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_BUILD_SEQUENCE=$MUSICBRAINZ_BUILD_SEQUENCE" >> "$GITHUB_ENV"

          DB_BUILD_SEQUENCE=$(sed -n 's/^ARG DB_BUILD_SEQUENCE=//p' build/postgres-prebuilt/Dockerfile)
          echo "DB_BUILD_SEQUENCE=${DB_BUILD_SEQUENCE:-0}" >> "$GITHUB_ENV"

          SIR_VERSION=$(sed -n 's/^ARG SIR_VERSION=//p' build/sir/Dockerfile)
          PYTHON_VERSION=$(sed -n 's/^ARG PYTHON_VERSION=//p' build/sir/Dockerfile)
          BASE_IMAGE_DATE=$(sed -n 's/^ARG BASE_IMAGE_DATE=//p' build/sir/Dockerfile)
          echo "SIR_VERSION=$SIR_VERSION" >> "$GITHUB_ENV"
          echo "PYTHON_VERSION=$PYTHON_VERSION" >> "$GITHUB_ENV"
          echo "BASE_IMAGE_DATE=$BASE_IMAGE_DATE" >> "$GITHUB_ENV"

          RABBITMQ_VERSION=$(sed -n 's/^ARG RABBITMQ_VERSION=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_VARIANT=$(sed -n 's/^ARG RABBITMQ_VARIANT=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_TAG="${RABBITMQ_VERSION}${RABBITMQ_VARIANT}"
          echo "RABBITMQ_VERSION=$RABBITMQ_VERSION" >> "$GITHUB_ENV"
          echo "RABBITMQ_VARIANT=$RABBITMQ_VARIANT" >> "$GITHUB_ENV"
          echo "RABBITMQ_TAG=$RABBITMQ_TAG" >> "$GITHUB_ENV"

          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags and build args
        run: |
          set -e
          BUILD_ARGS=""
          case "${{ matrix.name }}" in
            db)
              VERSION="$POSTGRES_VERSION"
              BUILD_ARGS=$'POSTGRES_VERSION='"$POSTGRES_VERSION"$'\nDB_BUILD_SEQUENCE='"$DB_BUILD_SEQUENCE"
              ;;
            musicbrainz)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            bootstrap)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            search)
              VERSION="$MB_SOLR_VERSION"
              BUILD_ARGS=$'MB_SOLR_VERSION='"$MB_SOLR_VERSION"
              ;;
            indexer)
              VERSION="$SIR_VERSION"
              BUILD_ARGS=$'SIR_VERSION='"$SIR_VERSION"$'\nPYTHON_VERSION='"$PYTHON_VERSION"$'\nBASE_IMAGE_DATE='"$BASE_IMAGE_DATE"
              ;;
            mq)
              VERSION="$RABBITMQ_TAG"
              BUILD_ARGS=$'RABBITMQ_VERSION='"$RABBITMQ_VERSION"$'\nRABBITMQ_VARIANT='"$RABBITMQ_VARIANT"$'\nRABBITMQ_TAG='"$RABBITMQ_TAG"
              ;;
            *)
              echo "Unknown image: ${{ matrix.name }}" >&2
              exit 1
              ;;
          esac

          TAGS="$IMAGE_NAMESPACE/${{ matrix.name }}:$VERSION"
          TAGS="$TAGS"$'\n'"$IMAGE_NAMESPACE/${{ matrix.name }}:sha-$SHORT_SHA"

          printf "TAGS<<'EOF'\n%s\nEOF\n" "$TAGS" >> "$GITHUB_ENV"
          printf "BUILD_ARGS<<'EOF'\n%s\nEOF\n" "$BUILD_ARGS" >> "$GITHUB_ENV"

      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ env.TAGS }}
          build-args: ${{ env.BUILD_ARGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
